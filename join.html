<!doctype html>
<html lang="en" referrerpolicy="origin">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AmorLink Rooms</title>
    <style>
      :root { --card:#ffffff; --border:#e5e7eb; --text:#111827; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:#f8fafc; }
      .bar { position:sticky; top:0; background:var(--card); padding:12px; display:flex; gap:12px; align-items:center; border-bottom:1px solid var(--border); z-index:10; }
      .grid { display:flex; gap:12px; flex-wrap:wrap; padding:12px; }
      video { width:240px; max-width:46vw; border-radius:12px; background:#000; }
      .status { font-weight:700; }
      button { padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer; border:1px solid var(--border); background:#fff; }
      .roomtag { margin-left:auto; opacity:0.7; font-size:14px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.6.1/dist/livekit-client.umd.min.js"></script>
  </head>
  <body>
    <div class="bar">
      <button id="join">Join with Camera & Mic</button>
      <button id="leave" disabled>Leave</button>
      <span class="status" id="status">idle</span>
      <span id="err" style="color:crimson"></span>
      <span class="roomtag" id="roomtag"></span>
    </div>
    <div id="grid" class="grid"></div>

    <script>
      const grid      = document.getElementById('grid');
      const joinBt    = document.getElementById('join');
      const leaveBt   = document.getElementById('leave');
      const status    = document.getElementById('status');
      const errEl     = document.getElementById('err');
      const tagEl     = document.getElementById('roomtag');

      const params = new URLSearchParams(location.search);
      const uiRoomId = params.get('rid') || 'amorlink-sandbox';
      tagEl.textContent = "Room: " + uiRoomId;

      let room = null;
      let parentOrigin = null;

      LivekitClient.setLogLevel('debug');
      console.log('[IFRAME] LivekitClient SDK version:', LivekitClient.version);

      function setStatus(s, e) {
        status.textContent = s;
        errEl.textContent = e ? (' â€” ' + e) : '';
        console.log('[IFRAME] Status:', s, e || '');
        if (parentOrigin) {
          window.parent.postMessage({ type: 'LK_STATE', state: s, reason: e }, parentOrigin);
        }
      }

      function requestToken() {
        console.log('[IFRAME] Requesting token from parent, origin:', parentOrigin || '*');
        window.parent.postMessage({ type:'REQUEST_TOKEN' }, parentOrigin || '*');
      }

      window.addEventListener('message', async (e) => {
        console.log('[IFRAME] Message received from:', e.origin, 'Type:', e.data?.type);
        
        // Set parent origin from first valid message
        if (!parentOrigin && e.data?.type) {
          parentOrigin = e.origin;
          console.log('[IFRAME] Parent origin set to:', parentOrigin);
        }
        
        // Only accept messages from the established parent origin
        if (parentOrigin && e.origin !== parentOrigin) {
          console.warn('[IFRAME] Ignoring message from wrong origin:', e.origin);
          return;
        }
        
        const { type, payload, message } = e.data || {};
        console.log('[IFRAME] Message from parent:', type, payload || message);
        
        if (type === 'TOKEN') {
          try {
            const { token, url } = payload;
            console.log('[IFRAME] Token received, connecting to LiveKit with URL:', url);
            await connectLiveKit(url, token);
            window.parent.postMessage({ type: 'JOINED' }, parentOrigin);
          } catch (err) {
            console.error('[IFRAME] connectLiveKit error:', err);
            setStatus('error', String(err));
            window.parent.postMessage({ type: 'LK_ERROR', reason: String(err) }, parentOrigin);
            joinBt.disabled = false;
          }
        }
        
        if (type === 'TOKEN_ERROR') {
          console.error('[IFRAME] Token error from parent:', message);
          setStatus('error', message || 'token error');
          window.parent.postMessage({ type: 'LK_ERROR', reason: message || 'token error' }, parentOrigin);
          joinBt.disabled = false;
        }
      });

      async function connectLiveKit(serverUrl, token) {
        setStatus('connecting');
        if (!window.LivekitClient || !window.LivekitClient.Room) {
          const err = 'LivekitClient SDK not found or not initialized correctly.';
          console.error('[IFRAME] LiveKit Error:', err);
          throw new Error(err);
        }
        const { Room, createLocalTracks, RoomEvent } = window.LivekitClient;
        room = new Room();
        
        room.on(RoomEvent.Disconnected, (reason) => {
           console.log('[IFRAME] Room disconnected:', reason);
           window.parent.postMessage({ type: 'LK_ERROR', reason: String(reason) }, parentOrigin);
           leave();
        });

        room.on(RoomEvent.ConnectionStateChanged, (state) => {
           console.log('[IFRAME] LiveKit connection state changed:', state);
           window.parent.postMessage({ type: 'LK_STATE', state: state }, parentOrigin);
        });

        let localTracks = [];
        try {
           console.log('[IFRAME] Attempting connection to:', serverUrl, 'with room:', uiRoomId);
           localTracks = await createLocalTracks({ audio:true, video:true });
           console.log('[IFRAME] Local tracks created:', localTracks.length);

           // Attach local video immediately
           localTracks.forEach(track => {
             if (track.kind === 'video') {
               const el = track.attach();
               el.muted = true;
               el.playsInline = true;
               el.autoplay = true;
               grid.prepend(el);
               console.log('[IFRAME] Local video track attached');
             }
           });

           console.log('[IFRAME] Connecting to room...');
           await room.connect(serverUrl, token, { tracks: localTracks });
           setStatus('connected');
           console.log('[IFRAME] Successfully connected to LiveKit room');
         } catch (e) {
           console.error('[IFRAME] LiveKit connection failed:', e, e.message, e.stack);
           window.parent.postMessage({ type: 'LK_ERROR', reason: `${e.message || String(e)}` }, parentOrigin);
           throw e;
         }

        function attach(pub){
          const t = pub.track; if (!t) return;
          const el = t.attach(); 
          el.playsInline = true; 
          el.autoplay = true;
          if (t.kind === 'video') {
            el.style.width='240px'; 
            el.style.borderRadius='12px';
          }
          grid.appendChild(el);
          console.log('[IFRAME] Attached', t.kind, 'track from', pub.trackSid);
        }
        function detach(pub){ 
          pub.track?.detach()?.forEach(el => el.remove()); 
          console.log('[IFRAME] Detached track', pub.trackSid);
        }

        room.on(RoomEvent.TrackSubscribed, (track, pub, participant) => {
          console.log('[IFRAME] TrackSubscribed:', track.kind, 'from', participant.identity);
          attach(pub);
        });
        room.on(RoomEvent.TrackUnsubscribed, (track, pub, participant) => {
          console.log('[IFRAME] TrackUnsubscribed:', track.kind, 'from', participant.identity);
          detach(pub);
        });

        room.on(RoomEvent.ParticipantConnected, (participant) => {
          console.log('[IFRAME] Participant connected:', participant.identity);
        });

        // Display existing participants
        if (room.remoteParticipants) {
          console.log('[IFRAME] Found', room.remoteParticipants.size, 'existing remote participants');
          Array.from(room.remoteParticipants.values()).forEach(participant => {
            console.log('[IFRAME] Processing participant:', participant.identity);
            console.log('[IFRAME] Participant tracks:', participant.trackPublications?.size || 0);

            if (participant.trackPublications) {
              Array.from(participant.trackPublications.values()).forEach(pub => { 
                console.log('[IFRAME] Track publication:', pub.trackSid, 'kind:', pub.kind, 'subscribed:', pub.isSubscribed, 'track:', !!pub.track);
                if (pub.isSubscribed && pub.track) {
                  console.log('[IFRAME] Attaching existing track:', pub.track.kind);
                  attach(pub); 
                }
              });
            }
          });
        }

        // Log all room participants after connection
        console.log('[IFRAME] Local participant:', room.localParticipant?.identity);
        console.log('[IFRAME] Remote participants count:', room.remoteParticipants?.size || 0);

        joinBt.disabled = true;
        leaveBt.disabled = false;
      }

      function leave() {
        console.log('[IFRAME] Leaving LiveKit room');
        try { room?.disconnect(); } catch (e) { console.error('[IFRAME] Error disconnecting:', e); }
        room = null;
        grid.querySelectorAll('video,audio').forEach(el => el.remove());
        joinBt.disabled = false;
        leaveBt.disabled = true;
        setStatus('idle');
        window.parent.postMessage({ type: 'LEFT' }, parentOrigin);
      }

      joinBt.addEventListener('click', () => { 
       if (!uiRoomId || uiRoomId === 'default') {
           alert('Room ID is missing. Cannot join.');
           return;
       }
       joinBt.disabled = true; 
       setStatus('requesting token'); 
       requestToken(); 
      });
      leaveBt.addEventListener('click', leave);
      window.addEventListener('beforeunload', leave);
    </script>
  </body>
</html>
